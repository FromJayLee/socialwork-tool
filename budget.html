<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ì‚¬íšŒë³µì§€ì‚¬ ì—…ë¬´ ê´€ë¦¬ ì‹œìŠ¤í…œ Â· ì‚¬ì—… ì˜ˆì‚°</title>

    <!-- í•„ê¸°ì²´ ë¡œê³  í°íŠ¸ (í™ˆê³¼ ë™ì¼) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">

    <style>
        /* ===== ê³µí†µ í† í°/ë ˆì´ì•„ì›ƒ (í™ˆ/ì‹¤ì ê³¼ ë™ì¼) ===== */
        :root {
            --bg: #0c0f13;
            --card: #151a22;
            --text: #e9edf2;
            --muted: #9aa3af;
            --line: #202633;
            --accent: #4da3ff;
            --accent-2: #77dd77;
            --danger: #ff5a5a;
            --chip: #1e2430;
            --radius: 16px;
            --gap: 16px;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Apple SD Gothic Neo, "Noto Sans KR", Pretendard, system-ui, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        a {
            color: inherit;
            text-decoration: none
        }

        header {
            position: sticky;
            top: 0;
            z-index: 20;
            backdrop-filter: saturate(180%) blur(12px);
            background: linear-gradient(180deg, rgba(12, 15, 19, 0.9), rgba(12, 15, 19, 0.6));
            border-bottom: 1px solid var(--line);
        }

        .wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 16px;
        }

        .head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 64px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px
        }

        .logo-mark {
            font-family: 'Pacifico', system-ui, cursive;
            font-size: 22px;
            font-weight: 700;
            letter-spacing: .2px;
            color: var(--text);
            text-shadow: 0 2px 12px rgba(77, 163, 255, .25);
        }

        nav {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap
        }

        .tab {
            padding: 8px 12px;
            border-radius: 10px;
            color: var(--muted);
            border: 1px solid transparent;
            transition: .2s
        }

        .tab:hover {
            color: var(--text);
            background: var(--chip);
            border-color: var(--line)
        }

        .tab.active {
            color: var(--text);
            background: #1a2230;
            border-color: #223148
        }

        .icon-btn {
            padding: 8px 10px;
            border-radius: 10px;
            background: var(--chip);
            border: 1px solid var(--line)
        }

        main {
            padding: 24px 0 56px
        }

        /* ì¹´ë“œ/í…ìŠ¤íŠ¸ */
        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--radius);
            padding: 16px
        }

        .card h3 {
            margin: 0 0 12px;
            font-size: 16px;
            font-weight: 700;
            color: #f2f6fb;
            display: flex;
            align-items: center;
            gap: 8px
        }

        .sub {
            color: var(--muted);
            font-size: 13px
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 999px;
            background: var(--chip);
            color: var(--muted);
            font-size: 12px;
            border: 1px solid var(--line)
        }

        .empty {
            padding: 10px;
            border: 1px dashed var(--line);
            border-radius: 12px;
            color: var(--muted);
            background: #10151a
        }

        .knum {
            font-variant-numeric: tabular-nums
        }

        /* ì…ë ¥/í•„í„° */
        .section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px
        }

        .title {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: space-between
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 140px
        }

        .field label {
            font-size: 12px;
            color: var(--muted)
        }

        input[type="date"],
        input[type="number"],
        input[type="text"],
        select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            background: #10151d;
            border: 1px solid var(--line);
            color: var(--text)
        }

        input[type="number"] {
            appearance: textfield
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            margin: 0;
            -webkit-appearance: none
        }

        .btn {
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid #223148;
            background: #162031;
            color: var(--text);
            cursor: pointer
        }

        .btn.ghost {
            background: #10151d;
            border-color: var(--line);
            color: var(--muted)
        }

        .btn.warn {
            background: #3a1c1c;
            border-color: #4a2525
        }

        .btn:disabled {
            opacity: .6;
            cursor: not-allowed
        }

        /* í…Œì´ë¸” */
        .twrap {
            overflow: auto;
            border: 1px solid var(--line);
            border-radius: 12px
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 860px
        }

        th,
        td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--line);
            text-align: left
        }

        th {
            color: #e9edf2;
            background: #121821;
            position: sticky;
            top: 0
        }

        tr:hover td {
            background: #111722
        }

        .right {
            text-align: right
        }

        .center {
            text-align: center
        }

        .muted {
            color: var(--muted)
        }

        /* ì‚¬ìš©ë¥  ë°” + ìƒíƒœ */
        .ratebar {
            height: 10px;
            background: #0d1219;
            border: 1px solid #1b2330;
            border-radius: 999px;
            overflow: hidden
        }

        .ratebar>i {
            display: block;
            height: 100%;
            background: linear-gradient(90deg, var(--accent-2), #b7ffb7);
            width: 0%
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 6px;
            border-radius: 999px;
            font-size: 12px;
            border: 1px solid var(--line);
            background: var(--chip);
            color: var(--muted)
        }

        .tag.red {
            background: #2a171a;
            color: #ffd7d7;
            border-color: #402027
        }

        .tag.yellow {
            background: #2a2517;
            color: #ffe4a3;
            border-color: #40321f
        }

        .over td {
            background: #221419 !important
        }

        /* ì‚¬ì—…ë³„ ì¹´ë“œ ì»¨í…Œì´ë„ˆ */
        #program-summaries {
            display: flex;
            flex-direction: column;
            gap: 16px
        }

        .prog-card .headrow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px
        }
    </style>
</head>

<body>
    <header>
        <div class="wrap head">
            <div class="logo">
                <div class="logo-mark" aria-label="ì‚¬íšŒë³µì§€ì‚¬ ì—…ë¬´ ê´€ë¦¬ ì‹œìŠ¤í…œ">ì‚¬íšŒë³µì§€ì‚¬ ì—…ë¬´ ê´€ë¦¬ ì‹œìŠ¤í…œ</div>
            </div>
            <nav aria-label="ì£¼ìš” íƒ­">
                <a class="tab" href="./index.html">í™ˆ</a>
                <a class="tab" href="./performance.html">ì‚¬ì—… ì‹¤ì </a>
                <a class="tab active" href="./budget.html" aria-current="page">ì‚¬ì—… ì˜ˆì‚°</a>
                <a class="tab" href="./schedule.html">ì‚¬ì—… ì¼ì •</a>
                <a class="tab" href="./settings.html">ì„¤ì •</a>
                <span class="icon-btn" title="ì•Œë¦¼">ğŸ””</span>
            </nav>
        </div>
    </header>

    <main class="wrap">
        <!-- ì˜ˆì‚° ì‚¬ìš© ì…ë ¥ -->
        <section class="card section" aria-label="ì˜ˆì‚° ì‚¬ìš© ì…ë ¥">
            <div class="title">
                <h3>ì˜ˆì‚° ì‚¬ìš© ì…ë ¥</h3>
                <div class="sub">í•­ëª©ì€ ì„¤ì • íƒ­ì˜ ì˜ˆì‚° ê³„íš ê¸°ë°˜. í•„ìš”í•˜ë©´ â€˜ì§ì ‘ì…ë ¥â€™ ì„ íƒ.</div>
            </div>
            <div class="toolbar" id="input-bar">
                <div class="field" style="min-width:160px">
                    <label for="in-date">ì¼ì</label>
                    <input id="in-date" type="date" />
                </div>
                <div class="field">
                    <label for="in-program">ì‚¬ì—…ëª…</label>
                    <select id="in-program"></select>
                </div>
                <div class="field">
                    <label for="in-a1">ì„¸ë¶€í™œë™1</label>
                    <select id="in-a1"></select>
                </div>
                <div class="field">
                    <label for="in-a2">ì„¸ë¶€í™œë™2(ì„ íƒ)</label>
                    <select id="in-a2"></select>
                </div>
                <div class="field" style="min-width:180px">
                    <label for="in-item">í•­ëª©</label>
                    <select id="in-item"></select>
                </div>
                <div class="field" style="min-width:180px; display:none" id="custom-item-wrap">
                    <label for="in-item-text">í•­ëª©(ì§ì ‘ì…ë ¥)</label>
                    <input id="in-item-text" type="text" placeholder="ì˜ˆ: ê°•ì‚¬ë¹„, ì¬ë£Œë¹„" />
                </div>
                <div class="field" style="min-width:140px">
                    <label for="in-amount">ì‚¬ìš©ê¸ˆì•¡(ì›)</label>
                    <input id="in-amount" type="number" inputmode="numeric" min="0" step="1" placeholder="0" />
                </div>
                <div style="margin-left:auto; display:flex; gap:8px; align-items:flex-end">
                    <button id="btn-add" class="btn">ì¶”ê°€</button>
                    <button id="btn-cancel" class="btn ghost" style="display:none">ì·¨ì†Œ</button>
                </div>
            </div>
            <div id="plan-hint" class="sub" style="margin-top:-4px"></div>
        </section>

        <!-- ë³´ê¸° í•„í„° (ìš”ì•½/ì›”í‘œ/ë¡œê·¸ì— ì ìš©) -->
        <section class="card section" aria-label="ë³´ê¸° í•„í„°">
            <div class="title">
                <h3>ë³´ê¸° í•„í„°</h3>
            </div>
            <div class="toolbar">
                <div class="field">
                    <label for="f-program">ì‚¬ì—…ëª…</label>
                    <select id="f-program"></select>
                </div>
                <div class="field">
                    <label for="f-a1">ì„¸ë¶€í™œë™1</label>
                    <select id="f-a1"></select>
                </div>
                <div class="field">
                    <label for="f-a2">ì„¸ë¶€í™œë™2</label>
                    <select id="f-a2"></select>
                </div>
                <div class="field">
                    <label for="f-ym">ì—°Â·ì›”(ìš”ì•½/ì›”í‘œ)</label>
                    <input id="f-ym" type="month" />
                </div>
                <div class="field">
                    <label for="f-year">ì—°ë„(ë¶„ê¸°í‘œ)</label>
                    <select id="f-year"></select>
                </div>
                <div style="display:flex; align-items:flex-end">
                    <button id="btn-reset-filter" class="btn ghost">í•„í„° ì´ˆê¸°í™”</button>
                </div>
            </div>
        </section>

        <!-- ì‚¬ì—…ë³„ ì˜ˆì‚° ìš”ì•½: í”„ë¡œê·¸ë¨ë§ˆë‹¤ ê°œë³„ í…Œì´ë¸” ìƒì„± -->
        <section class="section" aria-label="ì‚¬ì—…ë³„ ì˜ˆì‚° ìš”ì•½">
            <div class="title">
                <h3>ì‚¬ì—…ë³„ ì˜ˆì‚° ìš”ì•½</h3>
                <div class="sub">ì‚¬ìš©ë¥  = ì‚¬ìš©/ê³„íš. ê³„íšì´ ì—†ëŠ”ë° ì‚¬ìš©ì´ ìˆìœ¼ë©´ â€˜ë¹„ê³„íšâ€™ ì²˜ë¦¬.</div>
            </div>
            <div id="program-summaries"></div>
        </section>

        <!-- ì›”ë³„ í•©ê³„ -->
        <section class="section" aria-label="ì›”ë³„ í•©ê³„">
            <div class="title">
                <h3>ì›”ë³„ í•©ê³„ <span class="pill" id="label-month">-</span></h3>
                <div class="sub">ì„ íƒ ì—°Â·ì›” ê¸°ì¤€ ì‚¬ìš©ê¸ˆì•¡ í•©ê³„</div>
            </div>
            <div class="twrap">
                <table>
                    <thead>
                        <tr>
                            <th>ì‚¬ì—…ëª…</th>
                            <th class="right">ê¸ˆì•¡(ì›)</th>
                        </tr>
                    </thead>
                    <tbody id="tb-month">
                        <tr>
                            <td colspan="2">
                                <div class="empty">í•´ë‹¹ ì›” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- ì…ë ¥ ë¡œê·¸ -->
        <section class="section" aria-label="ì…ë ¥ ë¡œê·¸">
            <div class="title">
                <h3>ì…ë ¥ ë¡œê·¸</h3>
                <div style="display:flex; gap:8px; align-items:center">
                    <span class="sub">ìµœê·¼ìˆœ</span>
                    <button id="btn-export" class="btn ghost">CSV ë‚´ë³´ë‚´ê¸°</button>
                </div>
            </div>
            <div class="twrap">
                <table>
                    <thead>
                        <tr>
                            <th style="min-width:120px">ì¼ì</th>
                            <th>ì‚¬ì—…ëª…</th>
                            <th>ì„¸ë¶€í™œë™1</th>
                            <th>ì„¸ë¶€í™œë™2</th>
                            <th>í•­ëª©</th>
                            <th class="right">ê¸ˆì•¡(ì›)</th>
                            <th class="center" style="min-width:140px">ìˆ˜ì •</th>
                        </tr>
                    </thead>
                    <tbody id="tb-logs">
                        <tr>
                            <td colspan="7">
                                <div class="empty">ì…ë ¥ëœ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        /* ===== ìƒíƒœ (í™ˆ/ì‹¤ì ê³¼ ê³µìœ ) ===== */
        const LS_KEY = 'swms_home_v1';
        const EMPTY_STATE = Object.freeze({
            settings: { programs: [], activities: [], budgets: [], schedules: [] },
            performanceLogs: [], budgetLogs: []
        });
        function loadState() { try { const raw = localStorage.getItem(LS_KEY); return raw ? JSON.parse(raw) : structuredClone(EMPTY_STATE); } catch (e) { return structuredClone(EMPTY_STATE); } }
        function saveState(s) { localStorage.setItem(LS_KEY, JSON.stringify(s)); }

        /* ===== ìœ í‹¸ ===== */
        const today = new Date();
        const pad = n => String(n).padStart(2, '0');
        const fmtDate = d => { const T = d instanceof Date ? d : new Date(d); return `${T.getFullYear()}-${pad(T.getMonth() + 1)}-${pad(T.getDate())}`; }
        const ymFrom = d => { const T = d instanceof Date ? d : new Date(d); return `${T.getFullYear()}-${pad(T.getMonth() + 1)}`; }
        const sumBy = (arr, sel) => arr.reduce((s, x) => s + (+sel(x) || 0), 0);
        const $ = q => document.querySelector(q);

        /* ===== ì „ì—­ ===== */
        let state = loadState();
        let editingId = null;

        /* ===== í¼ DOM ===== */
        const inDate = $('#in-date'), inProgram = $('#in-program'), inA1 = $('#in-a1'), inA2 = $('#in-a2');
        const inItem = $('#in-item'), inItemText = $('#in-item-text'), customItemWrap = $('#custom-item-wrap');
        const inAmount = $('#in-amount'), btnAdd = $('#btn-add'), btnCancel = $('#btn-cancel'), planHint = $('#plan-hint');

        /* ===== í•„í„° DOM ===== */
        const fProgram = $('#f-program'), fA1 = $('#f-a1'), fA2 = $('#f-a2'), fYM = $('#f-ym'), fYear = $('#f-year'), btnResetFilter = $('#btn-reset-filter');

        /* ===== ì˜µì…˜ ì±„ìš°ê¸° ===== */
        function fillProgramOptions(selectEl, withAll = false) {
            selectEl.innerHTML = ''; if (withAll) selectEl.append(new Option('ì „ì²´', ''));
            state.settings.programs.forEach(p => selectEl.append(new Option(p.name, p.id)));
        }
        function fillA1Options(selectEl, programId, withAll = false) {
            selectEl.innerHTML = ''; if (withAll) selectEl.append(new Option('ì „ì²´', ''));
            if (!programId) return;
            const uniq = [...new Set(state.settings.activities.filter(a => a.programId === programId).map(a => a.a1))];
            uniq.forEach(a1 => selectEl.append(new Option(a1, a1)));
        }
        function fillA2Options(selectEl, programId, a1, withAll = false, emptyLabel = 'ì—†ìŒ') {
            selectEl.innerHTML = ''; if (withAll) selectEl.append(new Option('ì „ì²´', ''));
            if (!programId || !a1) { selectEl.append(new Option(emptyLabel, '')); return; }
            const list = state.settings.activities.filter(a => a.programId === programId && a.a1 === a1).map(a => a.a2);
            const uniq = [...new Set(list)];
            if (!withAll) selectEl.append(new Option(emptyLabel, ''));
            uniq.filter(v => v != null).forEach(a2 => selectEl.append(new Option(a2, a2)));
        }
        function fillItemOptions(selectEl, programId, a1, a2, allowCustom = true) {
            selectEl.innerHTML = '';
            const items = [...new Set(state.settings.budgets
                .filter(b => b.programId === programId && b.a1 === a1 && (b.a2 || '') === (a2 || ''))
                .map(b => b.item))];
            if (items.length === 0) { if (allowCustom) selectEl.append(new Option('ì§ì ‘ì…ë ¥', '__custom__')); return; }
            items.forEach(it => selectEl.append(new Option(it, it)));
            if (allowCustom) selectEl.append(new Option('ì§ì ‘ì…ë ¥', '__custom__'));
        }

        function showPlanHint() {
            const pid = inProgram.value, a1 = inA1.value, a2 = inA2.value || '';
            const plans = state.settings.budgets.filter(b => b.programId === pid && b.a1 === a1 && (b.a2 || '') === a2);
            if (plans.length === 0) { planHint.textContent = 'ì´ í™œë™ì— ë“±ë¡ëœ ê³„íš ì˜ˆì‚°ì´ ì—†ìŠµë‹ˆë‹¤. ì…ë ¥ ì‹œ ë¹„ê³„íš ì§€ì¶œë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.'; return; }
            const totalPlan = sumBy(plans, b => b.planned || 0);
            const used = sumBy(state.budgetLogs.filter(l => l.programId === pid && l.a1 === a1 && (l.a2 || '') === a2), l => l.amount || 0);
            planHint.textContent = `ê³„íš í•©ê³„: ${totalPlan.toLocaleString()}ì› Â· í˜„ì¬ ì‚¬ìš©: ${used.toLocaleString()}ì›`;
        }

        /* ===== ì´ˆê¸°í™” ===== */
        function initForm() {
            inDate.value = fmtDate(today);
            fillProgramOptions(inProgram, false);
            const pid = inProgram.value || state.settings.programs[0]?.id || '';
            fillA1Options(inA1, pid, false);
            fillA2Options(inA2, pid, inA1.value, false, 'ì—†ìŒ');
            fillItemOptions(inItem, pid, inA1.value, inA2.value || '', true);
            toggleCustomItem();

            inProgram.addEventListener('change', () => {
                fillA1Options(inA1, inProgram.value, false);
                fillA2Options(inA2, inProgram.value, inA1.value, false, 'ì—†ìŒ');
                fillItemOptions(inItem, inProgram.value, inA1.value, inA2.value || '', true);
                toggleCustomItem(); showPlanHint();
            });
            inA1.addEventListener('change', () => {
                fillA2Options(inA2, inProgram.value, inA1.value, false, 'ì—†ìŒ');
                fillItemOptions(inItem, inProgram.value, inA1.value, inA2.value || '', true);
                toggleCustomItem(); showPlanHint();
            });
            inA2.addEventListener('change', () => {
                fillItemOptions(inItem, inProgram.value, inA1.value, inA2.value || '', true);
                toggleCustomItem(); showPlanHint();
            });
            inItem.addEventListener('change', toggleCustomItem);

            btnAdd.addEventListener('click', onSubmit);
            btnCancel.addEventListener('click', resetEditing);

            showPlanHint();
        }
        function toggleCustomItem() { const custom = inItem.value === '__custom__'; customItemWrap.style.display = custom ? 'flex' : 'none'; }

        function initFilter() {
            fillProgramOptions(fProgram, true);
            fillA1Options(fA1, fProgram.value, true);
            fillA2Options(fA2, fProgram.value, fA1.value || '', true, 'ì „ì²´');
            fYM.value = ymFrom(today);
            fillYears(); fYear.value = String(today.getFullYear());

            fProgram.addEventListener('change', () => {
                fillA1Options(fA1, fProgram.value, true);
                fillA2Options(fA2, fProgram.value, fA1.value || '', true, 'ì „ì²´');
                refresh();
            });
            fA1.addEventListener('change', () => {
                fillA2Options(fA2, fProgram.value, fA1.value || '', true, 'ì „ì²´');
                refresh();
            });
            fA2.addEventListener('change', refresh);
            fYM.addEventListener('change', refresh);
            fYear.addEventListener('change', refresh);
            btnResetFilter.addEventListener('click', () => {
                fProgram.value = ''; fillA1Options(fA1, '', true); fA1.value = '';
                fillA2Options(fA2, '', '', true, 'ì „ì²´'); fA2.value = '';
                fYM.value = ymFrom(today); fYear.value = String(today.getFullYear());
                refresh();
            });
        }
        function fillYears() {
            const years = new Set(state.budgetLogs.map(l => new Date(l.date).getFullYear()));
            if (years.size === 0) years.add(today.getFullYear());
            fYear.innerHTML = '';[...years].sort((a, b) => a - b).forEach(y => fYear.append(new Option(String(y), String(y))));
        }

        /* ===== ì œì¶œ/í¸ì§‘ ===== */
        function onSubmit() {
            const date = inDate.value, programId = inProgram.value, a1 = inA1.value, a2 = inA2.value || null;
            const item = inItem.value === '__custom__' ? (inItemText.value || '').trim() : inItem.value;
            const amount = Math.max(0, parseInt(inAmount.value || '0', 10));

            if (!date || !programId || !a1 || !item) { alert('ì¼ì, ì‚¬ì—…ëª…, ì„¸ë¶€í™œë™1, í•­ëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }
            if (!(amount > 0)) { alert('ì‚¬ìš©ê¸ˆì•¡ì„ 1ì› ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.'); return; }

            const existsAct = state.settings.activities.some(a => a.programId === programId && a.a1 === a1 && (a.a2 || null) === (a2 || null));
            if (!existsAct) { alert('ì„¤ì • íƒ­ì— ì—†ëŠ” í™œë™ì…ë‹ˆë‹¤. ë¨¼ì € ì„¤ì •ì—ì„œ ë“±ë¡í•˜ì„¸ìš”.'); return; }

            if (editingId) {
                const idx = state.budgetLogs.findIndex(l => l.id === editingId);
                if (idx >= 0) { state.budgetLogs[idx] = { id: editingId, date, programId, a1, a2, item, amount }; saveState(state); resetEditing(); refresh(); }
            } else {
                const id = `${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 8)}`;
                state.budgetLogs.push({ id, date, programId, a1, a2, item, amount });
                saveState(state); clearInputs(); refresh();
            }
        }
        function clearInputs() { inDate.value = fmtDate(today); inAmount.value = ''; inItemText.value = ''; editingId = null; btnAdd.textContent = 'ì¶”ê°€'; btnCancel.style.display = 'none'; }
        function resetEditing() { editingId = null; btnAdd.textContent = 'ì¶”ê°€'; btnCancel.style.display = 'none'; inAmount.value = ''; inItemText.value = ''; }

        /* ===== í•„í„° ===== */
        function currentFilters() {
            return {
                programId: fProgram.value || '',
                a1: fA1.value || '',
                a2: fA2.value || '',
                ym: fYM.value || ymFrom(today),
                year: parseInt(fYear.value || String(today.getFullYear()), 10)
            };
        }
        function applyLogFilter(logs) {
            const { programId, a1, a2, ym } = currentFilters();
            return logs.filter(l => {
                if (programId && l.programId !== programId) return false;
                if (a1 && l.a1 !== a1) return false;
                if (a2 && (l.a2 || '') !== a2) return false;
                if (ym && ymFrom(l.date) !== ym) return false;
                return true;
            });
        }

        /* ===== ë£©ì—… ===== */
        function buildLookups() {
            const progById = new Map(state.settings.programs.map(p => [p.id, p]));
            const planByKey = new Map(); // key = pid|a1|a2|item
            state.settings.budgets.forEach(b => {
                const key = [b.programId, b.a1, b.a2 || '', b.item].join('|');
                planByKey.set(key, (planByKey.get(key) || 0) + (+b.planned || 0));
            });
            return { progById, planByKey };
        }

        /* ===== íŒŒìƒ (ì‚¬ì—…ë³„ ìš”ì•½) ===== */
        function deriveSummaryByProgram() {
            const { progById, planByKey } = buildLookups();
            const logs = applyLogFilter(state.budgetLogs);
            const usedByKey = new Map();
            logs.forEach(l => {
                const k = [l.programId, l.a1, l.a2 || '', l.item].join('|');
                usedByKey.set(k, (usedByKey.get(k) || 0) + (+l.amount || 0));
            });

            // í”„ë¡œê·¸ë¨ë³„ ë¬¶ìŒ
            const byProgram = new Map(); // pid -> rows[]
            // ê³„íš í‚¤ + ì‚¬ìš© í‚¤ ëª¨ë‘ ë°˜ì˜
            const allKeys = new Set([...planByKey.keys(), ...usedByKey.keys()]);
            allKeys.forEach(k => {
                const [pid, a1, a2s, item] = k.split('|'); const a2 = a2s || null;
                // í”„ë¡œê·¸ë¨ í•„í„°ê°€ ìˆìœ¼ë©´ ê·¸ í”„ë¡œê·¸ë¨ë§Œ ìœ ì§€
                const pf = currentFilters().programId; if (pf && pid !== pf) return;
                // í™œë™ í•„í„°ë„ ì ìš©
                const f1 = currentFilters().a1, f2 = currentFilters().a2;
                if (f1 && a1 !== f1) return; if (f2 && (a2 || '') !== f2) return;

                const planned = planByKey.get(k) || 0;
                const used = usedByKey.get(k) || 0;
                const remaining = planned - used;
                const rate = planned > 0 ? (used / planned) : null;
                const status = planned === 0 && used > 0 ? 'ë¹„ê³„íš' : (rate != null && rate > 1 ? 'ì´ˆê³¼' : (rate != null && rate >= 0.8 ? 'ì„ê³„' : 'ì •ìƒ'));
                const row = {
                    pid, programName: (progById.get(pid)?.name || pid),
                    a1, a2, item, planned, used, remaining, rate, status
                };
                if (!byProgram.has(pid)) byProgram.set(pid, []);
                byProgram.get(pid).push(row);
            });

            // ì •ë ¬
            byProgram.forEach(list => {
                list.sort((x, y) => {
                    if (x.programName !== y.programName) return x.programName.localeCompare(y.programName, 'ko');
                    if (x.a1 !== y.a1) return x.a1.localeCompare(y.a1, 'ko');
                    if ((x.a2 || '') !== (y.a2 || '')) return (x.a2 || '').localeCompare(y.a2 || '', 'ko');
                    return x.item.localeCompare(y.item, 'ko');
                });
            });

            return { progById, byProgram };
        }

        /* ===== íŒŒìƒ (ì›”í•©ê³„) ===== */
        function deriveMonthly() {
            const ym = currentFilters().ym; $('#label-month').textContent = ym;
            const byProg = new Map();
            state.budgetLogs.filter(l => ymFrom(l.date) === ym).forEach(l => {
                byProg.set(l.programId, (byProg.get(l.programId) || 0) + (+l.amount || 0));
            });
            return state.settings.programs.map(p => ({ programName: p.name, amount: byProg.get(p.id) || 0 }));
        }

        /* ===== ë Œë”: ì‚¬ì—…ë³„ ìš”ì•½(ì¹´ë“œ/í…Œì´ë¸”ì„ í”„ë¡œê·¸ë¨ë§ˆë‹¤ ìƒì„±) ===== */
        function renderProgramSummaries() {
            const host = document.getElementById('program-summaries');
            host.innerHTML = '';
            const { progById, byProgram } = deriveSummaryByProgram();

            // í‘œì‹œ ëŒ€ìƒ í”„ë¡œê·¸ë¨ ëª©ë¡(í•„í„° ì—†ìœ¼ë©´ ì „ì²´, ìˆìœ¼ë©´ í•´ë‹¹ë§Œ)
            const targetProgramIds = (() => {
                const pf = currentFilters().programId;
                if (pf) return [pf];
                return state.settings.programs.map(p => p.id);
            })();

            if (targetProgramIds.length === 0) {
                host.appendChild(el('div', { class: 'empty' }, 'ì„¤ì •ëœ ì‚¬ì—…ì´ ì—†ìŠµë‹ˆë‹¤.'));
                return;
            }

            let hasAnyRow = false;
            targetProgramIds.forEach(pid => {
                const progName = progById.get(pid)?.name || (state.settings.programs.find(p => p.id === pid)?.name) || pid;
                const list = byProgram.get(pid) || [];

                // ì¹´ë“œ
                const card = el('section', { class: 'card prog-card', 'aria-label': `${progName} ìš”ì•½` });
                const head = el('div', { class: 'headrow' },
                    el('h3', {}, progName),
                    el('div', { class: 'sub' }, 'í‘œì‹œëŠ” í˜„ì¬ í•„í„°(ì—°Â·ì›”/í™œë™)ì— ë”°ë¼ ë‹¬ë¼ì§‘ë‹ˆë‹¤.')
                );
                card.appendChild(head);

                // í…Œì´ë¸”
                const tw = el('div', { class: 'twrap' });
                const table = el('table', {},
                    el('thead', {}, el('tr', {},
                        el('th', { style: 'min-width:280px' }, 'í™œë™ Â· í•­ëª©'),
                        el('th', { class: 'right' }, 'ê³„íš(ì›)'),
                        el('th', { class: 'right' }, 'ì‚¬ìš©(ì›)'),
                        el('th', { class: 'right' }, 'ì”ì—¬(ì›)'),
                        el('th', { class: 'right' }, 'ì‚¬ìš©ë¥ '),
                        el('th', { style: 'min-width:140px' }, 'ì§„í–‰ë°”'),
                        el('th', { class: 'center' }, 'ìƒíƒœ')
                    )),
                    el('tbody', { id: `tb-sum-${pid}` })
                );
                tw.appendChild(table); card.appendChild(tw);
                host.appendChild(card);

                const tbody = table.querySelector('tbody');
                if (list.length === 0) {
                    tbody.appendChild(el('tr', {}, el('td', { colspan: '7' }, el('div', { class: 'empty' }, 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'))));
                } else {
                    hasAnyRow = true;
                    list.forEach(r => {
                        const pct = r.rate == null ? 0 : Math.min(100, Math.max(0, r.rate * 100));
                        const tr = el('tr', r.rate != null && r.rate > 1 ? { class: 'over' } : {},
                            el('td', {}, `${r.a1}${r.a2 ? (' Â· ' + r.a2) : ''} Â· ${r.item}`),
                            el('td', { class: 'right knum' }, r.planned.toLocaleString()),
                            el('td', { class: 'right knum' }, r.used.toLocaleString()),
                            el('td', { class: 'right knum' }, (r.remaining).toLocaleString()),
                            el('td', { class: 'right knum' }, r.rate == null ? '-' : (Math.round(pct) + '%')),
                            el('td', {}, el('div', { class: 'ratebar' }, el('i', { style: `width:${Math.round(pct)}%` }))),
                            el('td', { class: 'center' },
                                r.status === 'ë¹„ê³„íš' ? el('span', { class: 'tag red' }, 'ë¹„ê³„íš') :
                                    r.status === 'ì´ˆê³¼' ? el('span', { class: 'tag red' }, 'ì´ˆê³¼') :
                                        r.status === 'ì„ê³„' ? el('span', { class: 'tag yellow' }, '80%â†‘') :
                                            el('span', { class: 'tag' }, 'ì •ìƒ')
                            )
                        );
                        tbody.appendChild(tr);
                    });

                    // í•©ê³„
                    const planSum = sumBy(list, x => x.planned);
                    const usedSum = sumBy(list, x => x.used);
                    const remSum = planSum - usedSum;
                    const rate = planSum > 0 ? usedSum / planSum : null;
                    const pct = rate == null ? 0 : Math.min(100, Math.max(0, rate * 100));
                    const trS = el('tr', {},
                        el('td', {}, el('strong', {}, 'í•©ê³„')),
                        el('td', { class: 'right knum' }, el('strong', {}, planSum.toLocaleString())),
                        el('td', { class: 'right knum' }, el('strong', {}, usedSum.toLocaleString())),
                        el('td', { class: 'right knum' }, el('strong', {}, remSum.toLocaleString())),
                        el('td', { class: 'right knum' }, el('strong', {}, rate == null ? '-' : (Math.round(pct) + '%'))),
                        el('td', {}, el('div', { class: 'ratebar' }, el('i', { style: `width:${Math.round(pct)}%` }))),
                        el('td', {}, '')
                    );
                    tbody.appendChild(trS);
                }
            });

            if (!hasAnyRow) {
                host.appendChild(el('div', { class: 'empty' }, 'í•„í„° ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'));
            }
        }

        /* ===== ë Œë”: ì›”í•©ê³„ & ë¡œê·¸ ===== */
        function renderMonth() {
            const tbody = $('#tb-month');
            const rows = deriveMonthly();
            if (rows.every(r => r.amount === 0)) {
                tbody.innerHTML = `<tr><td colspan="2"><div class="empty">í•´ë‹¹ ì›” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div></td></tr>`; return;
            }
            tbody.innerHTML = '';
            rows.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${r.programName}</td><td class="right knum">${r.amount.toLocaleString()}</td>`;
                tbody.appendChild(tr);
            });
        }
        function renderLogs() {
            const tbody = $('#tb-logs');
            const logs = applyLogFilter(state.budgetLogs).slice().sort((a, b) => new Date(b.date) - new Date(a.date));
            if (logs.length === 0) { tbody.innerHTML = `<tr><td colspan="7"><div class="empty">ì…ë ¥ëœ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div></td></tr>`; return; }
            const progById = new Map(state.settings.programs.map(p => [p.id, p.name]));
            tbody.innerHTML = '';
            logs.forEach(l => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td class="knum">${fmtDate(l.date)}</td>
          <td>${progById.get(l.programId) || l.programId}</td>
          <td>${l.a1}</td>
          <td>${l.a2 || 'â€”'}</td>
          <td>${l.item}</td>
          <td class="right knum">${(+l.amount || 0).toLocaleString()}</td>
          <td class="center">
            <button class="btn ghost" data-act="edit" data-id="${l.id}">í¸ì§‘</button>
            <button class="btn warn" data-act="del" data-id="${l.id}">ì‚­ì œ</button>
          </td>
        `;
                tbody.appendChild(tr);
            });

            tbody.querySelectorAll('button[data-act="edit"]').forEach(b => {
                b.addEventListener('click', () => {
                    const id = b.getAttribute('data-id');
                    const row = state.budgetLogs.find(x => x.id === id); if (!row) return;
                    editingId = id;
                    inDate.value = fmtDate(row.date);
                    inProgram.value = row.programId;
                    fillA1Options(inA1, row.programId, false); inA1.value = row.a1;
                    fillA2Options(inA2, row.programId, row.a1, false, 'ì—†ìŒ'); inA2.value = row.a2 || '';
                    fillItemOptions(inItem, row.programId, row.a1, row.a2 || '', true);
                    const items = [...inItem.options].map(o => o.value);
                    if (!items.includes(row.item)) { inItem.value = '__custom__'; toggleCustomItem(); inItemText.value = row.item; }
                    else { inItem.value = row.item; toggleCustomItem(); inItemText.value = ''; }
                    inAmount.value = row.amount;
                    btnAdd.textContent = 'ì €ì¥'; btnCancel.style.display = 'inline-flex';
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    showPlanHint();
                });
            });
            tbody.querySelectorAll('button[data-act="del"]').forEach(b => {
                b.addEventListener('click', () => {
                    const id = b.getAttribute('data-id');
                    if (!confirm('ì´ ì˜ˆì‚° ì‚¬ìš© ë¡œê·¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                    state.budgetLogs = state.budgetLogs.filter(x => x.id !== id);
                    saveState(state); if (editingId === id) resetEditing(); refresh();
                });
            });
        }

        /* ===== CSV ë‚´ë³´ë‚´ê¸° ===== */
        function exportCSV() {
            const header = ['date', 'program', 'activity1', 'activity2', 'item', 'amount'];
            const progById = new Map(state.settings.programs.map(p => [p.id, p.name]));
            const rows = applyLogFilter(state.budgetLogs)
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .map(l => [
                    fmtDate(l.date),
                    (progById.get(l.programId) || l.programId),
                    l.a1, l.a2 || '', l.item, (+l.amount || 0)
                ]);
            const csv = [header, ...rows].map(r => r.map(x => {
                const s = String(x); return /[,"\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
            }).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `budget_${Date.now()}.csv`; a.click();
            URL.revokeObjectURL(url);
        }

        /* ===== ë„ìš°ë¯¸: ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„± ===== */
        function el(tag, attrs = {}, ...children) {
            const E = document.createElement(tag);
            Object.entries(attrs || {}).forEach(([k, v]) => E.setAttribute(k, v));
            children.flat().forEach(c => {
                if (c == null) return;
                if (c instanceof Node) E.appendChild(c);
                else E.appendChild(document.createTextNode(String(c)));
            });
            return E;
        }

        /* ===== ë¦¬í”„ë ˆì‹œ & ì´ˆê¸° ë°”ì¸ë”© ===== */
        function refresh() {
            renderProgramSummaries();
            renderMonth();
            renderLogs();
        }

        function init() {
            initForm();
            initFilter();
            document.getElementById('btn-export').addEventListener('click', exportCSV);
            refresh();
        }
        init();

        // ê°œë°œ í¸ì˜
        window.__swms = {
            load: () => loadState(),
            save: (s) => saveState(s),
            reset: () => { localStorage.setItem(LS_KEY, JSON.stringify(EMPTY_STATE)); location.reload(); }
        };
    </script>
</body>

</html>
