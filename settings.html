<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ì‚¬íšŒë³µì§€ì‚¬ ì—…ë¬´ ê´€ë¦¬ ì‹œìŠ¤í…œ Â· ì„¤ì •</title>

    <!-- í•„ê¸°ì²´ ë¡œê³  í°íŠ¸ (ë‹¤ë¥¸ íƒ­ê³¼ ë™ì¼) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #0c0f13;
            --card: #151a22;
            --text: #e9edf2;
            --muted: #9aa3af;
            --line: #202633;
            --accent: #4da3ff;
            --accent-2: #77dd77;
            --danger: #ff5a5a;
            --chip: #1e2430;
            --radius: 16px;
            --gap: 16px;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Apple SD Gothic Neo, "Noto Sans KR", Pretendard, system-ui, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        a {
            color: inherit;
            text-decoration: none
        }

        header {
            position: sticky;
            top: 0;
            z-index: 20;
            backdrop-filter: saturate(180%) blur(12px);
            background: linear-gradient(180deg, rgba(12, 15, 19, 0.9), rgba(12, 15, 19, 0.6));
            border-bottom: 1px solid var(--line);
        }

        .wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 16px;
        }

        .head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 64px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px
        }

        .logo-mark {
            font-family: 'Pacifico', system-ui, cursive;
            font-size: 22px;
            font-weight: 700;
            letter-spacing: .2px;
            color: var(--text);
            text-shadow: 0 2px 12px rgba(77, 163, 255, .25);
        }

        nav {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap
        }

        .tab {
            padding: 8px 12px;
            border-radius: 10px;
            color: var(--muted);
            border: 1px solid transparent;
            transition: .2s
        }

        .tab:hover {
            color: var(--text);
            background: var(--chip);
            border-color: var(--line)
        }

        .tab.active {
            color: var(--text);
            background: #1a2230;
            border-color: #223148
        }

        .icon-btn {
            padding: 8px 10px;
            border-radius: 10px;
            background: var(--chip);
            border: 1px solid var(--line)
        }

        main {
            padding: 24px 0 56px
        }

        .section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px
        }

        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--radius);
            padding: 16px
        }

        .card h3 {
            margin: 0 0 12px;
            font-size: 16px;
            font-weight: 700;
            color: #f2f6fb;
            display: flex;
            align-items: center;
            gap: 8px
        }

        .sub {
            color: var(--muted);
            font-size: 13px
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 140px
        }

        .field label {
            font-size: 12px;
            color: var(--muted)
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            background: #10151d;
            border: 1px solid var(--line);
            color: var(--text)
        }

        input[type="number"] {
            appearance: textfield
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            margin: 0;
            -webkit-appearance: none
        }

        .btn {
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid #223148;
            background: #162031;
            color: var(--text);
            cursor: pointer
        }

        .btn.ghost {
            background: #10151d;
            border-color: var(--line);
            color: var(--muted)
        }

        .btn.warn {
            background: #3a1c1c;
            border-color: #4a2525
        }

        .btn:disabled {
            opacity: .6;
            cursor: not-allowed
        }

        .empty {
            padding: 10px;
            border: 1px dashed var(--line);
            border-radius: 12px;
            color: var(--muted);
            background: #10151a
        }

        .knum {
            font-variant-numeric: tabular-nums
        }

        .twrap {
            overflow: auto;
            border: 1px solid var(--line);
            border-radius: 12px
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 860px
        }

        th,
        td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--line);
            text-align: left
        }

        th {
            color: #e9edf2;
            background: #121821;
            position: sticky;
            top: 0
        }

        tr:hover td {
            background: #111722
        }

        .right {
            text-align: right
        }

        .center {
            text-align: center
        }
    </style>
</head>

<body>
    <header>
        <div class="wrap head">
            <div class="logo">
                <div class="logo-mark" aria-label="ì‚¬íšŒë³µì§€ì‚¬ ì—…ë¬´ ê´€ë¦¬ ì‹œìŠ¤í…œ">ì‚¬íšŒë³µì§€ì‚¬ ì—…ë¬´ ê´€ë¦¬ ì‹œìŠ¤í…œ</div>
            </div>
            <nav aria-label="ì£¼ìš” íƒ­">
                <a class="tab" href="./index.html">í™ˆ</a>
                <a class="tab" href="./performance.html">ì‚¬ì—… ì‹¤ì </a>
                <a class="tab" href="./budget.html">ì‚¬ì—… ì˜ˆì‚°</a>
                <a class="tab" href="./schedule.html">ì‚¬ì—… ì¼ì •</a>
                <a class="tab active" href="./settings.html" aria-current="page">ì„¤ì •</a>
                <span class="icon-btn" title="ì•Œë¦¼">ğŸ””</span>
            </nav>
        </div>
    </header>

    <main class="wrap">
        <!-- 1) ì‚¬ì—… ê´€ë¦¬ -->
        <section class="card section" aria-label="ì‚¬ì—… ê´€ë¦¬">
            <h3>ì‚¬ì—… ê´€ë¦¬ <span class="sub">(ì‚¬ë¡€ê´€ë¦¬Â·ì§€ì—­ì¡°ì§í™”Â·ì„œë¹„ìŠ¤ì œê³µ)</span></h3>
            <div class="toolbar">
                <div class="field" style="min-width:220px">
                    <label for="p-name">ì‚¬ì—…ëª…</label>
                    <input id="p-name" type="text" placeholder="ì˜ˆ: í–‰ë³µë§˜, ë…¸ì¸êµì‹¤" />
                </div>
                <div class="field">
                    <label for="p-cat">ë¶„ë¥˜</label>
                    <select id="p-cat">
                        <option value="">ì„ íƒ</option>
                        <option value="ì‚¬ë¡€ê´€ë¦¬">ì‚¬ë¡€ê´€ë¦¬</option>
                        <option value="ì§€ì—­ì¡°ì§í™”">ì§€ì—­ì¡°ì§í™”</option>
                        <option value="ì„œë¹„ìŠ¤ì œê³µ">ì„œë¹„ìŠ¤ì œê³µ</option>
                    </select>
                </div>
                <div style="margin-left:auto; display:flex; gap:8px; align-items:flex-end">
                    <button id="p-add" class="btn">ì¶”ê°€</button>
                    <button id="p-cancel" class="btn ghost" style="display:none">ì·¨ì†Œ</button>
                </div>
            </div>
            <div class="twrap">
                <table>
                    <thead>
                        <tr>
                            <th style="min-width:220px">ì‚¬ì—…ëª…</th>
                            <th>ë¶„ë¥˜</th>
                            <th class="center" style="min-width:140px">ìˆ˜ì •</th>
                        </tr>
                    </thead>
                    <tbody id="tb-programs">
                        <tr>
                            <td colspan="3">
                                <div class="empty">ë“±ë¡ëœ ì‚¬ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 2) í™œë™ ëª©í‘œ -->
        <section class="card section" aria-label="í™œë™ ëª©í‘œ">
            <h3>í™œë™ ëª©í‘œ ì„¤ì • <span class="sub">ì„¸ë¶€í™œë™1 í•„ìˆ˜ Â· 2 ì„ íƒ</span></h3>
            <div class="toolbar">
                <div class="field">
                    <label for="a-prog">ì‚¬ì—…ëª…</label>
                    <select id="a-prog"></select>
                </div>
                <div class="field">
                    <label for="a-a1">ì„¸ë¶€í™œë™1</label>
                    <input id="a-a1" type="text" placeholder="ì˜ˆ: ê³µì˜ˆí™œë™ / ê±´ê°•ì²´ì¡°" />
                </div>
                <div class="field">
                    <label for="a-a2">ì„¸ë¶€í™œë™2(ì„ íƒ)</label>
                    <input id="a-a2" type="text" placeholder="ì˜ˆ: ìˆ˜ë©´ì²´ì¡°, ëŒ„ìŠ¤êµì‹¤" />
                </div>
                <div class="field" style="min-width:140px">
                    <label for="a-sessions">ëª©í‘œ íšŒê¸°</label>
                    <input id="a-sessions" type="number" inputmode="numeric" min="0" step="1" placeholder="0" />
                </div>
                <div class="field" style="min-width:160px">
                    <label for="a-people">ëª©í‘œ ì¸ì›(í•©ê³„)</label>
                    <input id="a-people" type="number" inputmode="numeric" min="0" step="1" placeholder="0" />
                </div>
                <div style="margin-left:auto; display:flex; gap:8px; align-items:flex-end">
                    <button id="a-add" class="btn">ì¶”ê°€</button>
                    <button id="a-cancel" class="btn ghost" style="display:none">ì·¨ì†Œ</button>
                </div>
            </div>
            <div class="twrap">
                <table>
                    <thead>
                        <tr>
                            <th style="min-width:260px">ì‚¬ì—… Â· í™œë™</th>
                            <th class="center">ëª©í‘œ íšŒê¸°</th>
                            <th class="right">ëª©í‘œ ì¸ì›</th>
                            <th class="center" style="min-width:140px">ìˆ˜ì •</th>
                        </tr>
                    </thead>
                    <tbody id="tb-activities">
                        <tr>
                            <td colspan="4">
                                <div class="empty">ë“±ë¡ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 3) ì˜ˆì‚° ê³„íš -->
        <section class="card section" aria-label="ì˜ˆì‚° ê³„íš">
            <h3>ì˜ˆì‚° ê³„íš ì„¤ì • <span class="sub">í™œë™Â·í•­ëª©ë³„ ê³„íšê¸ˆì•¡</span></h3>
            <div class="toolbar">
                <div class="field">
                    <label for="b-prog">ì‚¬ì—…ëª…</label>
                    <select id="b-prog"></select>
                </div>
                <div class="field">
                    <label for="b-a1">ì„¸ë¶€í™œë™1</label>
                    <select id="b-a1"></select>
                </div>
                <div class="field">
                    <label for="b-a2">ì„¸ë¶€í™œë™2(ì„ íƒ)</label>
                    <select id="b-a2"></select>
                </div>
                <div class="field" style="min-width:180px">
                    <label for="b-item">í•­ëª©</label>
                    <input id="b-item" type="text" placeholder="ì˜ˆ: ê°•ì‚¬ë¹„, ì¬ë£Œë¹„" />
                </div>
                <div class="field" style="min-width:160px">
                    <label for="b-plan">ê³„íšê¸ˆì•¡(ì›)</label>
                    <input id="b-plan" type="number" inputmode="numeric" min="0" step="1" placeholder="0" />
                </div>
                <div style="margin-left:auto; display:flex; gap:8px; align-items:flex-end">
                    <button id="b-add" class="btn">ì¶”ê°€</button>
                    <button id="b-cancel" class="btn ghost" style="display:none">ì·¨ì†Œ</button>
                </div>
            </div>
            <div class="twrap">
                <table>
                    <thead>
                        <tr>
                            <th style="min-width:320px">ì‚¬ì—… Â· í™œë™ Â· í•­ëª©</th>
                            <th class="right">ê³„íš(ì›)</th>
                            <th class="center" style="min-width:140px">ìˆ˜ì •</th>
                        </tr>
                    </thead>
                    <tbody id="tb-budgets">
                        <tr>
                            <td colspan="3">
                                <div class="empty">ë“±ë¡ëœ ì˜ˆì‚° ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 4) ì¼ì • ê³„íš -->
        <section class="card section" aria-label="ì¼ì • ê³„íš">
            <h3>ì¼ì • ê³„íš ì„¤ì • <span class="sub">íšŒê¸°ë²ˆí˜¸ëŠ” ëª©í‘œ íšŒê¸° ê¸°ì¤€ ìë™ ìƒì„±</span></h3>
            <div class="toolbar">
                <div class="field">
                    <label for="s-prog">ì‚¬ì—…ëª…</label>
                    <select id="s-prog"></select>
                </div>
                <div class="field">
                    <label for="s-a1">ì„¸ë¶€í™œë™1</label>
                    <select id="s-a1"></select>
                </div>
                <div class="field">
                    <label for="s-a2">ì„¸ë¶€í™œë™2(ì„ íƒ)</label>
                    <select id="s-a2"></select>
                </div>
                <div class="field" style="min-width:140px">
                    <label for="s-session">íšŒê¸°ë²ˆí˜¸</label>
                    <select id="s-session"></select>
                </div>
                <div class="field" style="min-width:160px">
                    <label for="s-date">ì˜ˆì •ì¼</label>
                    <input id="s-date" type="date" />
                </div>
                <div style="margin-left:auto; display:flex; gap:8px; align-items:flex-end">
                    <button id="s-add" class="btn">ì¶”ê°€</button>
                    <button id="s-cancel" class="btn ghost" style="display:none">ì·¨ì†Œ</button>
                </div>
            </div>
            <div class="twrap">
                <table>
                    <thead>
                        <tr>
                            <th style="min-width:300px">ì‚¬ì—… Â· í™œë™</th>
                            <th class="center">íšŒê¸°</th>
                            <th class="center">ì˜ˆì •ì¼</th>
                            <th class="center">ìƒíƒœ</th>
                            <th class="center" style="min-width:140px">ìˆ˜ì •</th>
                        </tr>
                    </thead>
                    <tbody id="tb-schedules">
                        <tr>
                            <td colspan="5">
                                <div class="empty">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        // ===== ìƒíƒœ (ë‹¤ë¥¸ íƒ­ê³¼ ê³µìœ ) =====
        const LS_KEY = 'swms_home_v1';
        const EMPTY_STATE = Object.freeze({
            settings: { programs: [], activities: [], budgets: [], schedules: [] },
            performanceLogs: [],
            budgetLogs: []
        });
        function loadState() { try { const raw = localStorage.getItem(LS_KEY); return raw ? JSON.parse(raw) : structuredClone(EMPTY_STATE); } catch { return structuredClone(EMPTY_STATE); } }
        function saveState(s) { localStorage.setItem(LS_KEY, JSON.stringify(s)); }

        // ===== ìœ í‹¸ =====
        const $ = q => document.querySelector(q);
        const pad = n => String(n).padStart(2, '0');
        const fmtDate = d => { const T = d instanceof Date ? d : new Date(d); return `${T.getFullYear()}-${pad(T.getMonth() + 1)}-${pad(T.getDate())}`; };
        const makeId = () => `${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 8)}`;

        // ===== ì „ì—­ =====
        let state = loadState();
        let editing = { program: null, activity: null, budget: null, schedule: null };

        // ===== DOM =====
        // í”„ë¡œê·¸ë¨
        const pName = $('#p-name'), pCat = $('#p-cat'), pAdd = $('#p-add'), pCancel = $('#p-cancel'), tbPrograms = $('#tb-programs');
        // í™œë™
        const aProg = $('#a-prog'), aA1 = $('#a-a1'), aA2 = $('#a-a2'), aSessions = $('#a-sessions'), aPeople = $('#a-people'), aAdd = $('#a-add'), aCancel = $('#a-cancel'), tbActivities = $('#tb-activities');
        // ì˜ˆì‚°
        const bProg = $('#b-prog'), bA1 = $('#b-a1'), bA2 = $('#b-a2'), bItem = $('#b-item'), bPlan = $('#b-plan'), bAdd = $('#b-add'), bCancel = $('#b-cancel'), tbBudgets = $('#tb-budgets');
        // ì¼ì •
        const sProg = $('#s-prog'), sA1 = $('#s-a1'), sA2 = $('#s-a2'), sSession = $('#s-session'), sDate = $('#s-date'), sAdd = $('#s-add'), sCancel = $('#s-cancel'), tbSchedules = $('#tb-schedules');

        // ===== ì˜µì…˜ ìœ í‹¸ =====
        function fillProgramOptions(sel, withEmpty = false) {
            sel.innerHTML = ''; if (withEmpty) sel.append(new Option('ì„ íƒ', ''));
            state.settings.programs.forEach(p => sel.append(new Option(p.name, p.id)));
        }
        function a1List(programId) {
            return [...new Set(state.settings.activities.filter(a => a.programId === programId).map(a => a.a1))];
        }
        function a2List(programId, a1) {
            return [...new Set(state.settings.activities.filter(a => a.programId === programId && a.a1 === a1).map(a => a.a2).filter(v => v != null && v !== ''))];
        }
        function fillA1Options(sel, programId, withEmpty = false) {
            sel.innerHTML = ''; if (withEmpty) sel.append(new Option('ì„ íƒ', ''));
            if (!programId) return; a1List(programId).forEach(v => sel.append(new Option(v, v)));
        }
        function fillA2Options(sel, programId, a1, withEmpty = true, emptyLabel = 'ì—†ìŒ') {
            sel.innerHTML = ''; if (withEmpty) sel.append(new Option(emptyLabel, ''));
            if (!programId || !a1) return; a2List(programId, a1).forEach(v => sel.append(new Option(v, v)));
        }
        function targetSessionsOf(programId, a1, a2) {
            const row = state.settings.activities.find(r => r.programId === programId && r.a1 === a1 && (r.a2 || '') === (a2 || ''));
            return row ? (+row.targetSessions || 0) : 0;
        }
        function fillSessionOptions(sel, programId, a1, a2) {
            sel.innerHTML = '';
            const n = targetSessionsOf(programId, a1, a2);
            if (n <= 0) { sel.append(new Option('ì„¤ì •ëœ íšŒê¸° ì—†ìŒ', '')); return; }
            sel.append(new Option('ì„ íƒ', ''));
            for (let i = 1; i <= n; i++) sel.append(new Option(String(i), String(i)));
        }

        // ===== ë Œë” =====
        function renderPrograms() {
            tbPrograms.innerHTML = '';
            if (state.settings.programs.length === 0) {
                tbPrograms.innerHTML = `<tr><td colspan="3"><div class="empty">ë“±ë¡ëœ ì‚¬ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</div></td></tr>`; return;
            }
            state.settings.programs.forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td>${p.name}</td>
          <td>${p.category || '-'}</td>
          <td class="center">
            <button class="btn ghost" data-edit="${p.id}">í¸ì§‘</button>
            <button class="btn warn" data-del="${p.id}">ì‚­ì œ</button>
          </td>`;
                tbPrograms.appendChild(tr);
            });
            tbPrograms.querySelectorAll('[data-edit]').forEach(btn => btn.onclick = () => {
                const id = btn.getAttribute('data-edit');
                const row = state.settings.programs.find(x => x.id === id); if (!row) return;
                editing.program = id; pName.value = row.name; pCat.value = row.category || '';
                pAdd.textContent = 'ì €ì¥'; pCancel.style.display = 'inline-block';
            });
            tbPrograms.querySelectorAll('[data-del]').forEach(btn => btn.onclick = () => {
                const id = btn.getAttribute('data-del');
                // ì—°ì‡„ ì œê±°
                state.settings.programs = state.settings.programs.filter(x => x.id !== id);
                state.settings.activities = state.settings.activities.filter(x => x.programId !== id);
                state.settings.budgets = state.settings.budgets.filter(x => x.programId !== id);
                state.settings.schedules = state.settings.schedules.filter(x => x.programId !== id);
                persist();
                renderAll();
            });
        }

        function renderActivities() {
            tbActivities.innerHTML = '';
            if (state.settings.activities.length === 0) {
                tbActivities.innerHTML = `<tr><td colspan="4"><div class="empty">ë“±ë¡ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</div></td></tr>`; return;
            }
            const progName = id => state.settings.programs.find(p => p.id === id)?.name || id;
            state.settings.activities
                .slice()
                .sort((a, b) => (progName(a.programId) + a.a1 + (a.a2 || '')).localeCompare(progName(b.programId) + b.a1 + (b.a2 || ''), 'ko'))
                .forEach(a => {
                    const title = `${progName(a.programId)} Â· ${a.a1}${a.a2 ? (' Â· ' + a.a2) : ''}`;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
            <td>${title}</td>
            <td class="center">${a.targetSessions ?? 0}</td>
            <td class="right">${(+a.targetParticipants || 0).toLocaleString()}</td>
            <td class="center">
              <button class="btn ghost" data-edit="${a.id}">í¸ì§‘</button>
              <button class="btn warn" data-del="${a.id}">ì‚­ì œ</button>
            </td>`;
                    tbActivities.appendChild(tr);
                });
            tbActivities.querySelectorAll('[data-edit]').forEach(btn => btn.onclick = () => {
                const id = btn.getAttribute('data-edit');
                const row = state.settings.activities.find(x => x.id === id); if (!row) return;
                editing.activity = id;
                aProg.value = row.programId; aA1.value = row.a1; aA2.value = row.a2 || '';
                aSessions.value = row.targetSessions || 0; aPeople.value = row.targetParticipants || 0;
                aAdd.textContent = 'ì €ì¥'; aCancel.style.display = 'inline-block';
            });
            tbActivities.querySelectorAll('[data-del]').forEach(btn => btn.onclick = () => {
                const id = btn.getAttribute('data-del');
                const row = state.settings.activities.find(x => x.id === id);
                state.settings.activities = state.settings.activities.filter(x => x.id !== id);
                // ë™ì¼ í‚¤ì˜ ì˜ˆì‚°/ì¼ì •ë„ ì œê±°(ì¶©ëŒ ë°©ì§€)
                if (row) {
                    const k = (r) => [r.programId, r.a1, (r.a2 || '')].join('|');
                    state.settings.budgets = state.settings.budgets.filter(b => k(b) !== k(row));
                    state.settings.schedules = state.settings.schedules.filter(s => k(s) !== k(row));
                }
                persist(); renderAll();
            });
        }

        function renderBudgets() {
            tbBudgets.innerHTML = '';
            if (state.settings.budgets.length === 0) {
                tbBudgets.innerHTML = `<tr><td colspan="3"><div class="empty">ë“±ë¡ëœ ì˜ˆì‚° ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.</div></td></tr>`; return;
            }
            const progName = id => state.settings.programs.find(p => p.id === id)?.name || id;
            state.settings.budgets
                .slice()
                .sort((x, y) => (progName(x.programId) + x.a1 + (x.a2 || '') + x.item).localeCompare(progName(y.programId) + y.a1 + (y.a2 || '') + y.item, 'ko'))
                .forEach(b => {
                    const title = `${progName(b.programId)} Â· ${b.a1}${b.a2 ? (' Â· ' + b.a2) : ''} Â· ${b.item}`;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
            <td>${title}</td>
            <td class="right">${(+b.planned || 0).toLocaleString()}</td>
            <td class="center">
              <button class="btn ghost" data-edit="${b.id}">í¸ì§‘</button>
              <button class="btn warn" data-del="${b.id}">ì‚­ì œ</button>
            </td>`;
                    tbBudgets.appendChild(tr);
                });
            tbBudgets.querySelectorAll('[data-edit]').forEach(btn => btn.onclick = () => {
                const id = btn.getAttribute('data-edit');
                const row = state.settings.budgets.find(x => x.id === id); if (!row) return;
                editing.budget = id;
                bProg.value = row.programId; fillA1Options(bA1, bProg.value, true); bA1.value = row.a1;
                fillA2Options(bA2, bProg.value, bA1.value, true, 'ì—†ìŒ'); bA2.value = row.a2 || '';
                bItem.value = row.item; bPlan.value = row.planned || 0;
                bAdd.textContent = 'ì €ì¥'; bCancel.style.display = 'inline-block';
            });
            tbBudgets.querySelectorAll('[data-del]').forEach(btn => btn.onclick = () => {
                const id = btn.getAttribute('data-del');
                state.settings.budgets = state.settings.budgets.filter(x => x.id !== id);
                persist(); renderBudgets();
            });
        }

        function renderSchedules() {
            tbSchedules.innerHTML = '';
            if (state.settings.schedules.length === 0) {
                tbSchedules.innerHTML = `<tr><td colspan="5"><div class="empty">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div></td></tr>`; return;
            }
            const progName = id => state.settings.programs.find(p => p.id === id)?.name || id;
            state.settings.schedules
                .slice()
                .sort((a, b) => (a.plannedDate || '').localeCompare(b.plannedDate || '') || (a.sessionNo || 0) - (b.sessionNo || 0))
                .forEach(s => {
                    const title = `${progName(s.programId)} Â· ${s.a1}${s.a2 ? (' Â· ' + s.a2) : ''}`;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
            <td>${title}</td>
            <td class="center">${s.sessionNo || '-'}íšŒì°¨</td>
            <td class="center">${s.plannedDate ? fmtDate(s.plannedDate) : '-'}</td>
            <td class="center">${s.done ? 'ì™„ë£Œ' : 'ì˜ˆì •'}</td>
            <td class="center">
              <button class="btn ghost" data-edit="${s.id}">í¸ì§‘</button>
              <button class="btn warn" data-del="${s.id}">ì‚­ì œ</button>
            </td>`;
                    tbSchedules.appendChild(tr);
                });
            tbSchedules.querySelectorAll('[data-edit]').forEach(btn => btn.onclick = () => {
                const id = btn.getAttribute('data-edit');
                const row = state.settings.schedules.find(x => x.id === id); if (!row) return;
                editing.schedule = id;
                sProg.value = row.programId; fillA1Options(sA1, sProg.value, true); sA1.value = row.a1;
                fillA2Options(sA2, sProg.value, sA1.value, true, 'ì—†ìŒ'); sA2.value = row.a2 || '';
                fillSessionOptions(sSession, sProg.value, sA1.value, sA2.value || ''); sSession.value = String(row.sessionNo || '');
                sDate.value = row.plannedDate ? fmtDate(row.plannedDate) : '';
                sAdd.textContent = 'ì €ì¥'; sCancel.style.display = 'inline-block';
            });
            tbSchedules.querySelectorAll('[data-del]').forEach(btn => btn.onclick = () => {
                const id = btn.getAttribute('data-del');
                state.settings.schedules = state.settings.schedules.filter(x => x.id !== id);
                persist(); renderSchedules();
            });
        }

        function renderAll() {
            // ë“œë¡­ë‹¤ìš´ ë™ê¸°í™”
            [aProg, bProg, sProg].forEach(sel => fillProgramOptions(sel, true));
            fillA1Options(bA1, bProg.value || '', true); fillA2Options(bA2, bProg.value || '', bA1.value || '', true, 'ì—†ìŒ');
            fillA1Options(sA1, sProg.value || '', true); fillA2Options(sA2, sProg.value || '', sA1.value || '', true, 'ì—†ìŒ');
            fillSessionOptions(sSession, sProg.value || '', sA1.value || '', sA2.value || '');
            renderPrograms(); renderActivities(); renderBudgets(); renderSchedules();
        }

        const persist = () => saveState(state);

        // ===== ì´ë²¤íŠ¸ =====
        // í”„ë¡œê·¸ë¨
        pAdd.onclick = () => {
            const name = (pName.value || '').trim(), category = pCat.value || '';
            if (!name || !category) { alert('ì‚¬ì—…ëª…ê³¼ ë¶„ë¥˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
            if (editing.program) {
                const row = state.settings.programs.find(p => p.id === editing.program); if (row) { row.name = name; row.category = category; }
                editing.program = null; pAdd.textContent = 'ì¶”ê°€'; pCancel.style.display = 'none';
            } else {
                if (state.settings.programs.some(p => p.name === name)) { alert('ë™ì¼í•œ ì‚¬ì—…ëª…ì´ ì´ë¯¸ ìˆìŠµë‹ˆë‹¤.'); return; }
                state.settings.programs.push({ id: makeId(), name, category });
            }
            pName.value = ''; pCat.value = ''; persist(); renderAll();
        };
        pCancel.onclick = () => { editing.program = null; pName.value = ''; pCat.value = ''; pAdd.textContent = 'ì¶”ê°€'; pCancel.style.display = 'none'; };

        // í™œë™
        aAdd.onclick = () => {
            const programId = aProg.value || '', a1 = (aA1.value || '').trim(), a2 = (aA2.value || '').trim() || null;
            const targetSessions = Math.max(0, parseInt(aSessions.value || '0', 10));
            const targetParticipants = Math.max(0, parseInt(aPeople.value || '0', 10));
            if (!programId || !a1) { alert('ì‚¬ì—…ëª…ê³¼ ì„¸ë¶€í™œë™1ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }
            const key = (r) => [r.programId, r.a1, (r.a2 || '')].join('|');
            if (editing.activity) {
                const row = state.settings.activities.find(r => r.id === editing.activity); if (row) {
                    const temp = { programId, a1, a2 }; if (state.settings.activities.some(r => r.id !== row.id && key(r) === key(temp))) { alert('ê°™ì€ ì‚¬ì—…Â·í™œë™ ì¡°í•©ì´ ì´ë¯¸ ìˆìŠµë‹ˆë‹¤.'); return; }
                    Object.assign(row, { programId, a1, a2, targetSessions, targetParticipants });
                }
                editing.activity = null; aAdd.textContent = 'ì¶”ê°€'; aCancel.style.display = 'none';
            } else {
                if (state.settings.activities.some(r => key(r) === [programId, a1, (a2 || '')].join('|'))) { alert('ê°™ì€ ì‚¬ì—…Â·í™œë™ ì¡°í•©ì´ ì´ë¯¸ ìˆìŠµë‹ˆë‹¤.'); return; }
                state.settings.activities.push({ id: makeId(), programId, a1, a2, targetSessions, targetParticipants });
            }
            aA1.value = ''; aA2.value = ''; aSessions.value = ''; aPeople.value = '';
            persist(); renderAll();
        };
        aCancel.onclick = () => { editing.activity = null; aAdd.textContent = 'ì¶”ê°€'; aCancel.style.display = 'none'; aA1.value = ''; aA2.value = ''; aSessions.value = ''; aPeople.value = ''; };

        // ì˜ˆì‚°
        bProg.onchange = () => { fillA1Options(bA1, bProg.value || '', true); fillA2Options(bA2, bProg.value || '', bA1.value || '', true, 'ì—†ìŒ'); };
        bA1.onchange = () => { fillA2Options(bA2, bProg.value || '', bA1.value || '', true, 'ì—†ìŒ'); };
        bAdd.onclick = () => {
            const programId = bProg.value || '', a1 = bA1.value || '', a2 = bA2.value || '' || null;
            const item = (bItem.value || '').trim(); const planned = Math.max(0, parseInt(bPlan.value || '0', 10));
            if (!programId || !a1 || !item) { alert('ì‚¬ì—…ëª…, ì„¸ë¶€í™œë™1, í•­ëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }
            const existsAct = state.settings.activities.some(a => a.programId === programId && a.a1 === a1 && (a.a2 || '') === (a2 || ''));
            if (!existsAct) { alert('ì„¤ì •ëœ í™œë™ì´ ì•„ë‹™ë‹ˆë‹¤. ë¨¼ì € í™œë™ì„ ë“±ë¡í•˜ì„¸ìš”.'); return; }
            const key = (r) => [r.programId, r.a1, (r.a2 || ''), r.item].join('|');
            if (editing.budget) {
                const row = state.settings.budgets.find(x => x.id === editing.budget); if (row) {
                    const temp = { programId, a1, a2, item };
                    if (state.settings.budgets.some(x => x.id !== row.id && key(x) === key(temp))) { alert('ë™ì¼í•œ í™œë™Â·í•­ëª©ì´ ì´ë¯¸ ìˆìŠµë‹ˆë‹¤.'); return; }
                    Object.assign(row, { programId, a1, a2, item, planned });
                }
                editing.budget = null; bAdd.textContent = 'ì¶”ê°€'; bCancel.style.display = 'none';
            } else {
                if (state.settings.budgets.some(x => key(x) === [programId, a1, (a2 || ''), item].join('|'))) { alert('ë™ì¼í•œ í™œë™Â·í•­ëª©ì´ ì´ë¯¸ ìˆìŠµë‹ˆë‹¤.'); return; }
                state.settings.budgets.push({ id: makeId(), programId, a1, a2, item, planned });
            }
            bItem.value = ''; bPlan.value = ''; persist(); renderBudgets();
        };
        bCancel.onclick = () => { editing.budget = null; bAdd.textContent = 'ì¶”ê°€'; bCancel.style.display = 'none'; bItem.value = ''; bPlan.value = ''; };

        // ì¼ì •
        sProg.onchange = () => { fillA1Options(sA1, sProg.value || '', true); fillA2Options(sA2, sProg.value || '', sA1.value || '', true, 'ì—†ìŒ'); fillSessionOptions(sSession, sProg.value || '', sA1.value || '', sA2.value || ''); };
        sA1.onchange = () => { fillA2Options(sA2, sProg.value || '', sA1.value || '', true, 'ì—†ìŒ'); fillSessionOptions(sSession, sProg.value || '', sA1.value || '', sA2.value || ''); };
        sA2.onchange = () => { fillSessionOptions(sSession, sProg.value || '', sA1.value || '', sA2.value || ''); };
        sAdd.onclick = () => {
            const programId = sProg.value || '', a1 = sA1.value || '', a2 = sA2.value || '' || null;
            const sessionNo = parseInt(sSession.value || '0', 10); const plannedDate = sDate.value ? fmtDate(sDate.value) : '';
            if (!programId || !a1 || !sessionNo || !plannedDate) { alert('ì‚¬ì—…ëª…, ì„¸ë¶€í™œë™1, íšŒê¸°, ì˜ˆì •ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
            const maxSession = targetSessionsOf(programId, a1, a2);
            if (maxSession <= 0) { alert('í•´ë‹¹ í™œë™ì˜ ëª©í‘œ íšŒê¸°ê°€ 0ì…ë‹ˆë‹¤. í™œë™ ëª©í‘œë¥¼ ë¨¼ì € ì„¤ì •í•˜ì„¸ìš”.'); return; }
            if (sessionNo < 1 || sessionNo > maxSession) { alert(`íšŒê¸°ë²ˆí˜¸ëŠ” 1~${maxSession} ë²”ìœ„ì—¬ì•¼ í•©ë‹ˆë‹¤.`); return; }
            const key = (r) => [r.programId, r.a1, (r.a2 || ''), r.sessionNo].join('|');
            if (editing.schedule) {
                const row = state.settings.schedules.find(x => x.id === editing.schedule); if (row) {
                    const temp = { programId, a1, a2, sessionNo };
                    if (state.settings.schedules.some(x => x.id !== row.id && key(x) === key(temp))) { alert('ë™ì¼ íšŒê¸°ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.'); return; }
                    Object.assign(row, { programId, a1, a2, sessionNo, plannedDate, done: !!row.done, doneDate: row.done ? (row.doneDate || plannedDate) : null });
                }
                editing.schedule = null; sAdd.textContent = 'ì¶”ê°€'; sCancel.style.display = 'none';
            } else {
                if (state.settings.schedules.some(x => key(x) === [programId, a1, (a2 || ''), sessionNo].join('|'))) { alert('ë™ì¼ íšŒê¸°ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.'); return; }
                state.settings.schedules.push({ id: makeId(), programId, a1, a2, sessionNo, plannedDate, done: false, doneDate: null });
            }
            sSession.value = ''; sDate.value = ''; persist(); renderSchedules();
        };
        sCancel.onclick = () => { editing.schedule = null; sAdd.textContent = 'ì¶”ê°€'; sCancel.style.display = 'none'; sSession.value = ''; sDate.value = ''; };

        // ===== ì´ˆê¸°í™” =====
        function init() {
            [aProg, bProg, sProg].forEach(sel => fillProgramOptions(sel, true));
            // ì¢…ì† ì´ˆê¸°
            fillA1Options(bA1, bProg.value || '', true); fillA2Options(bA2, bProg.value || '', bA1.value || '', true, 'ì—†ìŒ');
            fillA1Options(sA1, sProg.value || '', true); fillA2Options(sA2, sProg.value || '', sA1.value || '', true, 'ì—†ìŒ');
            fillSessionOptions(sSession, sProg.value || '', sA1.value || '', sA2.value || '');
            sDate.value = fmtDate(new Date());
            renderAll();
        }
        init();
    </script>
</body>

</html>

